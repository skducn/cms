<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
	<HEAD>
		<TITLE>惧上传类 - UpFile_Class V2.0 使用手册</TITLE>
		<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=gb2312">
		<STYLE TYPE="text/css"> <!-- .p9 { font-family: "宋体"; font-size: 10pt; text-decoration: none; }
	.stable { font-family: "宋体"; font-size: 10pt; text-decoration: none; border-collapse: collapse; }
	.stable1 { font-family: "宋体"; font-size: 10pt; text-decoration: none; border-collapse: collapse; }
	.style1 {color: #0000FF}
	--></STYLE>
	</HEAD>
	<BODY LEFTMARGIN="0" TOPMARGIN="0">
		<FONT SIZE="3"></FONT>
		<TABLE WIDTH="90%" BORDER="0" CELLPADDING="5" CELLSPACING="0" CLASS="p9">
			<TR>
				<TD COLSPAN="2">
					<TABLE WIDTH="100%" HEIGHT="100" BORDER="0" CELLPADDING="10" CELLSPACING="0">
						<TR>
							<TD BGCOLOR="#99ccff"><P><B><FONT SIZE="3" COLOR="#000000">无惧上传类 - UpFile_Class V2.1 使用手册</FONT></B></P>
								<P><FONT SIZE="2">作者:<A HREF="mailto:yjlrb@21cn.com">梁无惧</A> <A HREF="http://www.25cn.com">http://www.25cn.com</A>
										[<A HREF="http://www.cgknife.com/yjlrb/upfile.rar">下载</A>]&nbsp;</FONT></P>
							</TD>
						</TR>
					</TABLE>
				</TD>
			</TR>
			<TR>
				<TD COLSPAN="2"><STRONG>UpFile_Class 概述</STRONG></TD>
			</TR>
			<TR>
				<TD>　</TD>
				<TD>&nbsp;&nbsp;&nbsp;自从用ASP来编写网站，就无时无刻想找一种兼容性强，使用方便的上传方法，用过很多的无 
					组件上传方法，但是都存在使用不方便，兼容性差，速度慢等的问题。终于在2003年的元旦里，想 
					到了可以让上传文件达到最快的方法，经过10天的努力，整整10个版本的版本的更新，终于完成了第一个“无惧上传类V1.0”，这个版本与其它的上传类或方法相比，具有速度快，兼容性强， 
					使用方便等特点。<BR>
					&nbsp;&nbsp; 
					经过整整一年,在得到各大网友的支持下,并且在长期使用中针对该版的不足,开发了1.1,1.2等版本,由于为了向下兼容,放弃了很多新的特性,现在,结过审慎考虑,终于在2004年7月10日完成了"无惧上传类2.0"版,该版相对于前作在安全上作出了最大的改进,在类内部实现了上传类型的黑白名单,更多方便了各种上传的环境,即使黑客突破了上传程序,但是最终在保存文件时会使他的所有努力付之流水,该版在使用上比前作更加方便,更人性化了。由于添加和修改了不少属性值,在移植上需要作出比较大的修改。</TD>
			</TR>
			<TR>
				<TD HEIGHT="10" COLSPAN="2"></TD>
			</TR>
			<TR>
				<TD COLSPAN="2"><STRONG>UpFile_Class 公共属性</STRONG></TD>
			</TR>
			<TR>
				<TD WIDTH="30">　</TD>
				<TD><TABLE WIDTH="100%" BORDER="1" CELLPADDING="0" CELLSPACING="0" BORDERCOLOR="#999999" CLASS="stable">
						<TR VALIGN="middle">
							<TD WIDTH="210" HEIGHT="20"><IMG SRC="1.GIF" WIDTH="16" HEIGHT="16"> File</TD>
							<TD>&nbsp;文件域的集合,是一个<A HREF="#Dictionary">Dictionary 对象</A>,返回值一个<A HREF="#FileInfo_Class">FileInfo_Class</A>
								类。可读写。</TD>
						</TR>
						<TR VALIGN="middle">
							<TD WIDTH="150" HEIGHT="20"><IMG SRC="1.GIF" WIDTH="16" HEIGHT="16"> Form</TD>
							<TD>&nbsp;表单域的集合,是一个<A HREF="#Dictionary">Dictionary 对象</A>,返回对应表单域的值。可读写。</TD>
						</TR>
						<TR VALIGN="middle">
							<TD WIDTH="150" HEIGHT="20"><IMG SRC="1.GIF" WIDTH="16" HEIGHT="16"> isErr</TD>
							<TD>&nbsp;返回错误的数值。-1表示无错,1表示没有上传数据,2表示上传超出限制。只读。</TD>
						</TR>
						<TR VALIGN="middle">
							<TD WIDTH="150" HEIGHT="20"><IMG SRC="1.GIF" WIDTH="16" HEIGHT="16"> Version</TD>
							<TD>&nbsp;获取类的版本信息。只读。</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="1.GIF" WIDTH="16" HEIGHT="16"> AllowExt</TD>
							<TD>&nbsp;白名单，允许上传的文件类型，可以在类文件里预设可上传的文件类型,以文件的后缀名来判断,不区分大小写,每个后缀名用“;”号分开。如AllowExt="jpg;rar;zip"。可读写。</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="1.GIF" WIDTH="16" HEIGHT="16"> NoAllowExt
							</TD>
							<TD>&nbsp;黑名单，不允许上传的文件类型，可以在类文件里预设不可上传的文件类型,以文件的后缀名来判断,不区分大小写,每个后缀名用“;”号分开。如NoAllowExt="asp;htm;html;js;"。可读写</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="1.GIF" WIDTH="16" HEIGHT="16"> ErrMessage
							</TD>
							<TD>&nbsp;错误信息，在发生错误时，可以调用ErrMessage显示错误的字符串信息。只读。</TD>
						</TR>
					</TABLE>
				</TD>
			</TR>
			<TR>
				<TD HEIGHT="10" COLSPAN="2"></TD>
			</TR>
			<TR>
				<TD COLSPAN="2"><STRONG>UpFile_Class 公共方法</STRONG></TD>
			</TR>
			<TR>
				<TD>　</TD>
				<TD><TABLE WIDTH="100%" BORDER="1" CELLPADDING="0" CELLSPACING="0" BORDERCOLOR="#999999" CLASS="stable">
						<TR VALIGN="middle">
							<TD WIDTH="210" HEIGHT="20"><IMG SRC="2.GIF" WIDTH="16" HEIGHT="16"> GetData(MaxSize 
								As Int64)</TD>
							<TD>&nbsp;分析上传的数据。MaxSize为限制上传的字节,设为-1即不限制大小，此为过程，没有返回值，调用后调检查isErr是否大于0。</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="2.GIF" WIDTH="16" HEIGHT="16"> SaveToFile(Item As 
								String,Path As String)</TD>
							<TD>&nbsp;保存到文件,自动覆盖已存在的同名文件，Item为表单项名，Path为保存的绝对路径，返回值为保存的文件名。</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="2.GIF" WIDTH="16" HEIGHT="16"> AutoSave(Item As 
								String,Path As String)</TD>
							<TD>&nbsp;保存到文件,自动创建文件名以避免重复，Item为表单的名，Path为保存的绝对路径（可不包含文件名，如e:\wwwroot\upimg\),返回值为保存的文件名。</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="2.GIF" WIDTH="16" HEIGHT="16"> FileData(Item As String)</TD>
							<TD>&nbsp;取得文件数据，Item为表单项名</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="2.GIF" WIDTH="16" HEIGHT="16"> GetFilePath(FullPath As 
								String)
							</TD>
							<TD>&nbsp;返回文件在路径，如GetFilePath("c:\a.asp") 返回值为"c:\"。
							</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="2.GIF" WIDTH="16" HEIGHT="16"> GetFileName(FullPath As 
								String)
							</TD>
							<TD>&nbsp;返回文件名，如GetFileName("c:\a.asp") 返回值为"a.asp"。
							</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="2.GIF" WIDTH="16" HEIGHT="16"> GetFileExt(FullPath As 
								String)
							</TD>
							<TD>&nbsp;返回文件的后缀名，如GetFileExt("c:\a.asp") 返回值为"asp"。
							</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="2.GIF" WIDTH="16" HEIGHT="16"> GetNewFileName()
							</TD>
							<TD>&nbsp;返回一个以时间种子的不重复数值，可以用作文件名。</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="2.GIF" WIDTH="16" HEIGHT="16"> isAllowExt(Ext As String)</TD>
							<TD>&nbsp;返回一个真假值指是Ext是否为可上传的类型,如isAllowExt("jpg")。</TD>
						</TR>
					</TABLE>
				</TD>
			</TR>
			<TR>
				<TD HEIGHT="5" COLSPAN="2">&nbsp;</TD>
			</TR>
			<TR>
				<TD HEIGHT="5" COLSPAN="2"><STRONG>UpFile_Class 受保护方法</STRONG></TD>
			</TR>
			<TR>
				<TD HEIGHT="5">&nbsp;</TD>
				<TD HEIGHT="5"><TABLE WIDTH="100%" BORDER="1" CELLPADDING="0" CELLSPACING="0" BORDERCOLOR="#999999" CLASS="stable1">
						<TR VALIGN="middle">
							<TD WIDTH="210" HEIGHT="20"><IMG SRC="3.GIF" WIDTH="16" HEIGHT="16"> SaveToFileEx(Item 
								As String,Path As String,Over As bool)</TD>
							<TD>&nbsp;保存到文件，其中Over指示如果文件存在是否覆盖，如果OVER为真时，文件按PATH来保存，如果OVER为假，则自动调用<IMG SRC="2.GIF" WIDTH="16" HEIGHT="16">
								GetNewFileName() 生成一个新的不重复的文件名，以上传时的后缀名保存。</TD>
						</TR>
					</TABLE>
				</TD>
			</TR>
			<TR>
				<TD HEIGHT="2" COLSPAN="2">&nbsp;</TD>
			</TR>
			<TR>
				<TD HEIGHT="2" COLSPAN="2"><STRONG><A NAME="FileInfo_Class"></A>FileInfo_Class 概述</STRONG></TD>
			</TR>
			<TR>
				<TD HEIGHT="3">&nbsp;</TD>
				<TD HEIGHT="3">文件信息类,用来存贮上传的文件信息</TD>
			</TR>
			<TR>
				<TD HEIGHT="10" COLSPAN="2">&nbsp;</TD>
			</TR>
			<TR>
				<TD COLSPAN="2"><STRONG>FileInfo_Class 公共属性</STRONG></TD>
			</TR>
			<TR>
				<TD>　</TD>
				<TD><TABLE WIDTH="100%" BORDER="1" CELLPADDING="0" CELLSPACING="0" BORDERCOLOR="#999999" CLASS="stable">
						<TR VALIGN="middle">
							<TD WIDTH="210" HEIGHT="20"><IMG SRC="1.GIF" WIDTH="16" HEIGHT="16"> FileName</TD>
							<TD>&nbsp;返回上传的文件名。</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="1.GIF" WIDTH="16" HEIGHT="16"> FilePath</TD>
							<TD>&nbsp;返回上传时文件在客户端的路径。</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="1.GIF" WIDTH="16" HEIGHT="16"> FileExt</TD>
							<TD>&nbsp;返回文件扩展名。</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="1.GIF" WIDTH="16" HEIGHT="16"> FileMIME</TD>
							<TD>&nbsp;返回文件MIME类别。</TD>
						</TR>
						<TR VALIGN="middle">
							<TD HEIGHT="20"><IMG SRC="1.GIF" WIDTH="16" HEIGHT="16"> FileSize</TD>
							<TD>&nbsp;返回文件大小(以字节为单位)。</TD>
						</TR>
					</TABLE>
				</TD>
			</TR>
			<TR>
				<TD HEIGHT="10" COLSPAN="2"></TD>
			</TR>
			<TR>
				<TD COLSPAN="2">　</TD>
			</TR>
			<TR>
				<TD COLSPAN="2"><STRONG><A NAME="Dictionary" ID="Dictionary"></A>Dictionary 对象</STRONG> 请参考VBSCRIPT帮助取得更详细的属性和方法</TD>
			</TR>
			<TR>
				<TD COLSPAN="2">　</TD>
			</TR>
			<TR>
				<TD COLSPAN="2"><STRONG>UPFILE_CLASS 特性 </STRONG>
				</TD>
			</TR>
			<TR>
				<TD>　</TD>
				<TD><P><STRONG>版本更新</STRONG><BR>
						0.96&nbsp; 第一个公开版本，以新的解析方法达到速度上的一个提升，修改稻香老农的无组件上传类，以达到完全兼容。</P>
					<P><BR>
						1.0&nbsp;&nbsp; 
						发现原版中一个无法避免的BUG，会导至黑客利用服务器在上传其间会占用100%CPU资源来达到拒绝服务攻击，故修改了原来的设用方法，增加一个GetData来在实际上传数据前对上传文件的大小进行判断，防止被上传超大文件。至于其它的改变，忘掉了。<BR>
						1.2&nbsp;&nbsp; 修改了1.0中的一些错误命名（俺的英语不好），整理部分代码和加入更多对代码的注释。<BR>
						2.0&nbsp;&nbsp; 
						更加稳定和更安全，加入了上传类型的黑白名单，自动保存，修改了文件类中的一个属性，原为FileType现在改为FileMIME，增加了几个常用的方法。<BR>
					</P>
					<P><STRONG>使用中的一些问题解答</STRONG></P>
					<P>1、什么时候用AutoSave和SaveToFile？<BR>
						&nbsp;&nbsp; 
						AutoSave是自动生成新的文件名以避免与服务器上的原文件同名，而SaveToFile则是覆盖存在的文件，所以，如果你上传的文件需要覆盖原文件的时候，那么就调用SaveToFile,如果你上传的文件不需要覆盖存在的文件，那么就调用AutoSave，该函数会返回所保存的文件名。</P>
					<P>2、为什么不提供自全部保存？<BR>
						&nbsp;&nbsp; 
						我不太相信大家用上传类时不需要对文件进行处理，那么提供全部保存与分别保存并没有什么太大的区别，在能少不多的情况下，我没有加入这个功能。</P>
					<P>3、为什么我保存的时候会提示“该类型不允许上传呢”？我没有执行判断啊！<BR>
						&nbsp;&nbsp; 
						这是因为程序内部进行了判断，为了防止由于外部调用代码的BUG而导至判断上传类型失效，在内部的保存和取得数据都自动进行了文件类型的判别，如果黑名单存在，则白名单不起作用，这是为了方便一些程序的使用，因为有些时间只需要禁止几个上传类型即可，而不需要对每个上传类型进行判别。</P>
					<P><STRONG>关于网友的一些问题</STRONG></P>
					<P>1、为什么上传的时候会出现无效页？<BR>
						&nbsp;&nbsp;&nbsp; 
						这是因为IE的BUG所导至的，目前尚没有更好的解决方法，原理是：当客户端提交表单时，IE会首先发把上传的总大小传到服务器，而这时服务器开始执行ASP代码，当运行到GetData方法时，会首先判断上传的总大小是为超过程序预设大小，如果没有，则开始执行上传，这时IE才真正开始上传数据，但是如果上传的总大小为超过程序预设大小，那么程序自动放弃读取并退出执行，这时上传并没有真正开始，虽然服务器返回了错误信息给IE，但是IE由于设计当初没有考虑到服务器会拒绝表单的上传，故IE会继续等待服务器的上传回应，由于服务器已经终止上传，IE就会以为服务器没有响应而出现无效页的错误了。</P>
					<P>2、为什么从1.2马上升到了2.0？好像代码改得不多啊！<BR>
						&nbsp;&nbsp;&nbsp; 这是因为大家都喜欢高版本，我巴不得改为7.0呢，那样大家都会觉得这个版真高级。。。。-_-||</P>
				</TD>
			</TR>
			<TR>
				<TD COLSPAN="2"><P>　</P>
				</TD>
			</TR>
			<TR>
				<TD COLSPAN="2"><STRONG>使 用 示 例</STRONG></TD>
			</TR>
			<TR>
				<TD COLSPAN="2"><P>上传文件的表单要加入enctype="multipart/form-data"属性，即<BR>
						&lt;form name="form1" method="post" action="" enctype="multipart/form-data"&gt;<BR>
						&lt;input type="text" value="1" name="name"&gt;<BR>
						&lt;input type=file name="img"&gt;<BR>
						&lt;input type=submit name="submit" value="提交"&gt;
						<BR>
						&lt;/form&gt;<BR>
					</P>
					<P>
						在执行上传的ASP页<BR>
						<SPAN CLASS="style1">'包含类文件</SPAN><BR>
						&lt;!-- #include file="upfile_class.asp" --&gt;<BR>
						dim upfile<BR>
						dim SaveFilename
						<BR>
						<SPAN CLASS="style1">'建立上传对象</SPAN><BR>
						set upfile=new upfile_class
						<BR>
						<SPAN CLASS="style1">'取得上传数据,限制最大上传10M 计算方法为 10240000/1000000=10.24M<BR>
        </SPAN>
						upfile.GetData (10240000)<BR>
						<FONT COLOR="#0000ff">'判决是否出错</FONT><BR>
						if upfile.isErr then<BR>
						&nbsp;&nbsp;select case upfile.err<BR>
						&nbsp;&nbsp;&nbsp;&nbsp;case 1<BR>
						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Response.Write "你没有上传数据呀???是不是搞错了??"<BR>
						&nbsp;&nbsp;&nbsp;&nbsp;case 2<BR>
						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Response.Write "你上传的文件超出我们的限制,最大10M"<BR>
						&nbsp;&nbsp;end select<BR>
						&nbsp;&nbsp;else<BR>
						<SPAN CLASS="style1">&nbsp;&nbsp;'执行保存文件代码</SPAN><BR>
						&nbsp;&nbsp; upfile.SaveToFile "img","c:\"&amp;upfile.file("img").filename<BR>
						&nbsp;
						<SPAN CLASS="style1">'执行自动保存文件代码，SaveFilename为保存的文件名</SPAN><BR>
						&nbsp;&nbsp; SaveFilename=upfile.AutoSave("img","c:\")<BR>
						<SPAN CLASS="style1">&nbsp;&nbsp; '销毁对像</SPAN><BR>
						&nbsp; set upfile=nothing<BR>
						end if</P>
				</TD>
			</TR>
			<TR>
				<TD COLSPAN="2"><P>　</P>
				</TD>
			</TR>
			<TR>
				<TD COLSPAN="2">目录下包含了一个完整的示例,分别<A HREF="example/upfiletodb.asp">存到数据库</A>及<A HREF="example/upfiletofile.htm">存为文件</A>,详细请参考.</TD>
			</TR>
			<TR>
				<TD COLSPAN="2">　</TD>
			</TR>
			<TR>
				<TD COLSPAN="2"><STRONG>梁无惧 于2004年7月10日修改</STRONG></TD>
			</TR>
		</TABLE>
		<P>　</P>
		<P>　</P>
		<P>
		</P>
		<DIV ALIGN="right">
			<P>　</P>
		</DIV>
	</BODY>
</HTML>
